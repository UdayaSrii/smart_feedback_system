<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Feedback Hub Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f8fafc; --neg: #ef4444; --pos: #22c55e; --neu: #a7a49f; --warn: #9a3412; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.06); text-align: center; width: 400px; }
        .admin-card { width: 1100px; max-width: 95vw; text-align: left; }
        .hidden { display: none !important; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #e2e8f0; border-radius: 12px; font-size: 14px; outline: none; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; background: var(--primary); color: white; transition: 0.2s; }
        .btn:disabled { background: #cbd5e1; cursor: not-allowed; }
        #inline-msg { margin-top: 15px; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 14px; opacity: 0; transition: opacity 0.5s ease; display: none; }
        .admin-layout { display: flex; gap: 20px; margin-top: 20px; }
        .chart-box { flex: 1; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee; display: flex; flex-direction: column; align-items: center; }
        .table-box { flex: 2; border: 1px solid #eee; border-radius: 15px; overflow-y: auto; max-height: 450px; background: white; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 12px; text-align: left; position: sticky; top: 0; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .priority-row { background: #fff5f5; }
        .admin-link { margin-top: 25px; color: #94a3b8; font-size: 12px; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div id="user-view" class="card">
        <h2 style="color: var(--primary)">Send Feedback</h2>
        <input type="text" id="u-name" placeholder="Name (Optional)">
        <div style="position: relative;">
            <textarea id="u-msg" placeholder="Your thoughts..." rows="4" maxlength="200" oninput="updateCounter()"></textarea>
            <small id="char-count" style="position: absolute; bottom: 15px; right: 10px; color: #94a3b8; font-size: 11px;">0 / 200</small>
        </div>
        <button class="btn" id="submit-btn" onclick="submitFeedback()" disabled>Submit</button>
        <div id="inline-msg"></div>
        <p onclick="showLogin()" class="admin-link">Admin Login</p>
    </div>

    <div id="login-view" class="card hidden">
        <h2>Admin Access</h2>
        <input type="text" id="l-user" placeholder="Username">
        <input type="password" id="l-pass" placeholder="Password">
        <button class="btn" onclick="adminLogin()">Login</button>
        <p onclick="location.reload()" class="admin-link">‚Üê Back</p>
    </div>

    <div id="admin-dashboard" class="card admin-card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">Feedback Intelligence</h2>
            <div>
                <button onclick="clearAll()" style="background:var(--neg); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:bold; margin-right:10px;">Clear All Data</button>
                <button onclick="location.reload()" style="background:#f1f5f9; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">Logout</button>
            </div>
        </div>
        <div class="admin-layout">
            <div class="chart-box">
                <h4 style="margin:0 0 15px 0;">Sentiment Distribution</h4>
                <div style="width:220px; height:220px;"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="table-box">
                <table>
                    <thead><tr><th>User</th><th>Message</th><th>Mood</th><th style="text-align:center;">Action</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let myChart = null;

        function updateCounter() {
            const msg = document.getElementById('u-msg');
            const count = document.getElementById('char-count');
            const btn = document.getElementById('submit-btn');
            count.innerText = `${msg.value.length} / 200`;
            btn.disabled = msg.value.length === 0;
            count.style.color = msg.value.length >= 180 ? 'var(--neg)' : '#94a3b8';
        }

        async function submitFeedback() {
            const msgInput = document.getElementById('u-msg');
            const box = document.getElementById('inline-msg');
            const res = await fetch('/api/feedback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    username: document.getElementById('u-name').value || "Anonymous",
                    message: msgInput.value
                })
            });

            if (res.status === 400) {
                box.innerHTML = "‚ö†Ô∏è <b>Wait!</b> Please use appropriate language. ü§ê";
                box.style.background = "#ffedd5"; box.style.color = "var(--warn)";
                box.style.display = 'block'; box.style.opacity = '1';
                return;
            }

            const data = await res.json();
            if (data.sentiment === 'Positive') { box.innerHTML = "‚ú® <b>Great!</b> We love the vibes! üòç"; box.style.background = "#dcfce7"; box.style.color = "#166534"; }
            else if (data.sentiment === 'Negative') { box.innerHTML = "üì© <b>Received.</b> We're on it! üõ†Ô∏è"; box.style.background = "#fee2e2"; box.style.color = "#991b1b"; }
            else { box.innerHTML = "‚öñÔ∏è <b>Thanks!</b> We appreciate the input. üëç"; box.style.background = "#fef3c7"; box.style.color = "#92400e"; }

            box.style.display = 'block';
            setTimeout(() => box.style.opacity = '1', 10);
            msgInput.value = ''; updateCounter();
            setTimeout(() => { box.style.opacity = '0'; setTimeout(() => box.style.display = 'none', 500); }, 5000);
        }

        async function deleteFeedback(id) {
            if (confirm("Delete this comment?")) { await fetch(`/api/feedback/${id}`, { method: 'DELETE' }); loadDashboard(); }
        }

        async function clearAll() {
            if (confirm("‚ö†Ô∏è Delete ALL feedback permanently?") && confirm("FINAL WARNING: Are you sure?")) {
                await fetch('/api/feedback/clear_all', { method: 'DELETE' });
                loadDashboard();
            }
        }

        function showLogin() { document.getElementById('user-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); }

        async function adminLogin() {
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({identifier: document.getElementById('l-user').value, password: document.getElementById('l-pass').value})
            });
            if(res.ok) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('admin-dashboard').classList.remove('hidden'); loadDashboard(); }
            else { alert("Login Failed"); }
        }

        async function loadDashboard() {
            const res = await fetch('/api/history');
            const json = await res.json();
            const data = json.data;
            const counts = { Positive: 0, Negative: 0, Neutral: 0 };
            data.forEach(i => counts[i.sentiment]++);

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Pos', 'Neg', 'Neu'], datasets: [{ data: [counts.Positive, counts.Negative, counts.Neutral], backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'] }] }
            });

            data.sort((a,b) => (a.sentiment === 'Negative' && b.sentiment !== 'Negative' ? -1 : 1));
            document.getElementById('table-body').innerHTML = data.map(i => `
                <tr class="${i.sentiment === 'Negative' ? 'priority-row' : ''}">
                    <td><b>${i.username}</b></td>
                    <td>${i.message}</td>
                    <td style="color:${i.sentiment==='Negative'?'red':'green'}; font-weight:bold;">${i.sentiment}</td>
                    <td style="text-align:center;"><button style="background:none; border:none; cursor:pointer;" onclick="deleteFeedback('${i.id}')">üóëÔ∏è</button></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>